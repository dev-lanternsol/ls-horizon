{% comment %}
  Circular Arc Features Section
  
  A dynamic section that displays feature items positioned along a circular arc path.
  Features are arranged in a semi-circle around a central content box that updates
  based on user interaction (hover on desktop, click on mobile).
  
  Key Features:
  - Customizable arc positioning (radius, start/end angles)
  - Responsive layout (arc on desktop, stacked list on mobile)
  - Interactive center content box that updates on feature selection
  - Optional popup modals linked to keywords in center content
  - SVG dotted arc line connecting feature points
  - Customizable colors and spacing
  
  Section Settings:
  - center_image: Main image displayed in the center
  - heading: Heading text above the arc
  - description: Optional description text
  - arc_color: Color of the connecting arc line and active feature borders
  - arc_radius_percent: Size of the arc (20-48%)
  - start_angle: Starting angle of the arc (0-360°)
  - end_angle: Ending angle of the arc (0-720°)
  - connector_length: Length of feature connector lines (40-120px)
  
  Block Settings (Feature):
  - icon: Feature icon image
  - title: Feature title text
  - description: Feature description (rich text)
  - content_heading: Heading shown in center box when active
  - content_text: Text shown in center box when active
  - open_by_default: Whether this feature is active by default
  - popup_page: Optional page content for popup modal
  - popup_keyword: Keyword in content_text that triggers popup
  - x_offset/y_offset: Fine-tune feature position (0-100%)
  
  Behavior:
  - Desktop: Hover over features to update center content
  - Mobile: Click features to expand and show center content
  - First feature (or one marked as default) is active on load
  - Popup modals can be triggered by clicking keywords in center text
  
  @author Jose
  @version 1.0
{% endcomment %}

{% style %}
  .circular-arc-section-{{ section.id }} {
    overflow: hidden;
    position: relative;
    .arc-container {
      position: relative;
      max-width: 100rem;
      margin: 0 auto;
      padding: 1.25rem;
    }
    .arc-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 85%;
      /* Adjusted for aspect ratio */
      margin-bottom: -12rem;
      margin-top: -3rem;
    }
    .arc-content {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    .center-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 0;
      width: 100%;
      max-width: var(--center-content-max-width);
    }
    .center-box {
      margin-top: -4.375rem;
      position: relative;
      z-index: 1;
    }
    .center-image {
      width: 24rem;
      height: auto;
      display: block;
      margin: 0 auto;
      position: absolute;
      z-index: 0;
      left: 0;
      right: 0;
      padding-top: 20rem;
    }
    .feature-item {
      position: absolute;
      opacity: 0;
      transition: opacity 0.3s ease;
      transform: translate(-50%, -50%);
    }
    .feature-item.positioned {
      opacity: 1;
    }
    .feature-inner {
      position: relative;
      width: 100%;
    }
    .feature-icon-wrapper {
      width: 4.6875rem;
      height: 4.6875rem;
      background: var(--color-foreground);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0.1250rem 0.9375rem rgba(0,0,0,0.12);
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }
    .feature-item.active .feature-icon-wrapper {
      border: 0.1875rem solid var(--color-border);
    }
    .feature-icon {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: contain;
      color: var(--color-background);
    }
    .feature-content {
      position: absolute;
      top: 50%;
      justify-content: center;
      z-index: 2;
      width: 23rem;
      display: flex;
      flex-direction: column;
      @media only screen and (max-width: 749px) {
        text-align: left;
        padding-top: var(--padding-block-start-mobile);
        padding-bottom: calc(var(--padding-block-end-mobile) / 2);
      }
    }
    .feature-item:not(.active) .feature-content {
      @media only screen and (max-width: 749px) {
        padding-bottom: var(--padding-block-end-mobile);
      }
    }
    .feature-content.align-center {
      text-align: center;
    }
    .feature-title {
      font-size: 1.0625rem;
      font-weight: bold;
      line-height: 1.23;
      font-family: var(--font-paragraph--family);
      /* Optional margin override */
      margin-bottom: 0rem;
      @media only screen and (min-width: 750px) {
        margin-bottom: 0.75rem;
      }
    }
    .feature-description {
      font-size: 0.875rem;     
      line-height: 1.28;
      padding-top: 0.3rem;
    }
    .main-arc-path path {
      fill: none;
      stroke: var(--color-border);
      stroke-width: 0.1875rem;
      stroke-dasharray: 3, 6; /* 0.1250rem dot, 0.3750rem gap */
      stroke-linecap: round; /* Makes the dashes into dots */
    }

    @media only screen and (min-width: 750px) {
      .feature-content.align-left {
        text-align: left;
        padding-left: 2rem;
        right: 0;
        transform: translate(var(--x-offset), var(--y-offset));
      }
      .feature-content.align-right {
        text-align: right;
        padding-right: 2rem;
        left: 0;
        transform: translate(calc(var(--x-offset) * -1), var(--y-offset));
      }
    }
    @media (max-width: 749px) {
      padding: 3.7500rem 0.9375rem;
      .arc-wrapper {
        min-height: unset;
        padding-bottom: 0;
        margin: 0;
      }
      .arc-container {
        padding: 0;
      }
      .arc-header {
        margin-bottom: 2rem;
      }
      .arc-content > img {
        display: none;
      }
      .feature-icon-wrapper {
        width: 2.8125rem;
        height: 2.8125rem;
      }
      .arc-content,
      .feature-item,
      .feature-content {
        position: relative;
      }
      .feature-center-data {
        display: none;
        margin-bottom: 1.6875rem;
      }
      .feature-item {
        transform: translate(0, 0);
        .feature-icon-wrapper{
          position: absolute;
          top: 0;
          left: 0;
        }
        .feature-content,
        .feature-center-data {
          padding-left: 3.75rem;
        }
      } 
      .feature-item.positioned.active {
        .feature-center-data {
          display: block;
        }
      }
      .feature-content {
        transform: translateY(0);
      }
      .feature-title {
        font-size: 0.9375rem;
      }
      .feature-description p {
        font-size: 0.9375rem;
      }
    }
  }
{% endstyle %}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="section color-{{ section.settings.color_scheme }}"
  data-testid="ui-test-section"

  {% if request.visual_preview_mode %}
    data-shopify-visual-preview
  {% endif %}
>
  <div
        class="
          spacing-style
          layout-panel-flex
          layout-panel-flex--{{ section.settings.content_direction }}
          section-content-wrapper
        "
        style="
          {% render 'layout-panel-style', settings: section.settings %}
          {% render 'spacing-style', settings: section.settings %}
        "
        data-testid="section-content"
      >
    <div class="circular-arc-section-{{ section.id }}">
      <div class="arc-container text-{{ section.settings.alignment }}">
        <div class="arc-header">
          {% if section.blocks.size > 1 %}
            {% content_for "block", type: "text", id: "arc-features-heading" %}
            {% content_for "block", type: "text", id: "arc-features-description" %}
          {% endif %}
        </div>
        <div class="arc-wrapper" id="arc-wrapper-{{ section.id }}">
          <div class="arc-content" id="arc-content-{{ section.id }}">
            <svg class="main-arc-path" id="main-arc-{{ section.id }}" 
              width="100%" height="100%" 
              style="position: absolute; top: 0; left: 0; z-index: 0;">
            </svg>
            <!-- Center Content -->
            {% if section.settings.center_image %}
              <img src="{{ section.settings.center_image | image_url: width: 600 }}" 
                    alt="{{ section.settings.heading }}"
                    class="center-image"
                    loading="lazy">
            {% endif %}
            <div class="center-content hidden--mobile"
              style="--center-content-max-width: {{ section.settings.center_content_max_width }}%;">
              <div class="center-box"
                style="--border-radius: 1rem;">
                <!-- Section content should be pulled from each block and should change based on which block is active, block "active" is done with the hover feature on desktop and with click on mobile -->
                <div class="center-box-content" id="center-box-content-{{ section.id }}">
                </div>
              </div>
            </div>
            <!-- Feature Items -->
            {% content_for 'blocks' %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const radiusPercent = {{ section.settings.arc_radius_percent |  minus: 3 }};
  const connectorLength = 0; // Removed connector line length setting
  const startAngle = {{ section.settings.start_angle }};
  const endAngle = {{ section.settings.end_angle }};
  
  // --- Helper function to convert polar coords to cartesian ---
  function polarToCartesian(cx, cy, r, angleDeg) {
    const angleRad = (angleDeg) * (Math.PI / 180.0);
    return {
      x: cx + (r * Math.cos(angleRad)),
      y: cy + (r * Math.sin(angleRad))
    };
  }

  // --- Helper function to generate SVG arc path data ---
  function describeArc(x, y, radius, startAngle, endAngle) {
    const start = polarToCartesian(x, y, radius, startAngle);
    const end = polarToCartesian(x, y, radius, endAngle);
    
    const arcSpan = endAngle - startAngle;
    const largeArcFlag = (arcSpan % 360) <= 180 ? "0" : "1";
    const sweepFlag = "1"; 

    const d = [
      "M", start.x, start.y,
      "A", radius, radius, 0, largeArcFlag, sweepFlag,
      end.x, end.y
    ].join(" ");
    
    return d;
  }
  
  // --- Update center box content ---
  function updateCenterBox(featureItem) {
    const centerBoxTarget = document.getElementById('center-box-content-' + sectionId);
    if (!centerBoxTarget) return;

    const featureCenterData = featureItem.querySelector('.feature-center-data');

    centerBoxTarget.innerHTML = '';
    
    if (featureCenterData) {
      centerBoxTarget.innerHTML = featureCenterData.innerHTML;
    }
  }
  
  // --- Setup interaction handlers ---
  function setupInteractions() {
    const content = document.getElementById('arc-content-' + sectionId);
    if (!content) return;
    
    const features = content.querySelectorAll('.feature-item');
    const isMobile = window.innerWidth < 1100;
    
    features.forEach((feature) => {
      // Remove existing listeners
      const newFeature = feature.cloneNode(true);
      feature.parentNode.replaceChild(newFeature, feature);
    });
    
    // Re-query after cloning
    const freshFeatures = content.querySelectorAll('.feature-item');
    
    // Set default active item
    let hasDefault = false;
    
    if (!isMobile) {
      // Desktop: use data-default if available
      freshFeatures.forEach((feature) => {
        if (feature.hasAttribute('data-default')) {
          feature.classList.add('active');
          updateCenterBox(feature);
          hasDefault = true;
        }
      });
    }
    
    // If no default (or on mobile), activate the first item
    if (!hasDefault && freshFeatures.length > 0) {
      freshFeatures[0].classList.add('active');
      updateCenterBox(freshFeatures[0]);
    }
    
    freshFeatures.forEach((feature) => {
      if (isMobile) {
        // Mobile: click to activate
        feature.addEventListener('click', function(e) {
          e.preventDefault();
          // Don't reactivate if already active
          if (feature.classList.contains('active')) return;
          
          freshFeatures.forEach(f => f.classList.remove('active'));
          feature.classList.add('active');
          updateCenterBox(feature);
        });
      } else {
        // Desktop: hover to activate
        feature.addEventListener('mouseenter', function() {
          // Don't reactivate if already active
          if (feature.classList.contains('active')) return;
          
          freshFeatures.forEach(f => f.classList.remove('active'));
          feature.classList.add('active');
          updateCenterBox(feature);
        });
      }
    });
  }
  
  function positionFeatures() {
    const wrapper = document.getElementById('arc-wrapper-' + sectionId);
    const content = document.getElementById('arc-content-' + sectionId);
    
    if (!wrapper || !content) return;
    
    const features = content.querySelectorAll('.feature-item');
    if (features.length === 0) return;
    
    const isDesktop = window.innerWidth >= 749;
    
    // Only apply arc positioning on desktop
    if (isDesktop) {
      const rect = content.getBoundingClientRect();
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      
      // Calculate radius based on container size
      const radius = Math.min(rect.width, rect.height) * (radiusPercent / 100);
      
      // Calculate the arc span
      const arcSpan = endAngle - startAngle;
      
      // --- Draw the main arc ---
      const svg = document.getElementById('main-arc-' + sectionId);
      if (svg) {
        svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
        
        const arcPathD = describeArc(centerX, centerY, radius, startAngle, endAngle);
        
        let path = svg.querySelector('path');
        if (!path) {
          path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          svg.appendChild(path);
        }
        path.setAttribute("d", arcPathD);
      }
      
      features.forEach((feature, index) => {
        // Calculate angle within the specified arc range
        const angleStep = features.length > 1 ? arcSpan / (features.length - 1) : 0;
        const angleDeg = startAngle + (angleStep * index);
        
        // Convert to radians
        const angle = (angleDeg) * (Math.PI / 180);
        
        // Calculate position
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        
        // Position feature
        feature.style.left = x + 'px';
        feature.style.top = y + 'px';
        
        // Determine text alignment based on position
        const content = feature.querySelector('.feature-content');
        if (content) {
          if (x < centerX - 50) {
            content.classList.add('align-right');
            content.classList.remove('align-left', 'align-center');
          } else if (x > centerX + 50) {
            content.classList.add('align-left');
            content.classList.remove('align-right', 'align-center');
          } else {
            content.classList.add('align-center');
            content.classList.remove('align-left', 'align-right');
          }
        }
        
        // Position and rotate connector line
        const connector = feature.querySelector('.feature-connector');
        if (connector) {
          const rotateDeg = angleDeg + 90;
          connector.style.height = connectorLength + 'px';
          connector.style.transform = 'translateX(-50%) rotate(' + rotateDeg + 'deg)';
          connector.style.top = '-' + connectorLength + 'px';
        }
        
        // Show feature
        feature.classList.add('positioned');
      });
    } else {
      // Mobile: reset arc positioning, clear SVG
      const svg = document.getElementById('main-arc-' + sectionId);
      if (svg) {
        svg.innerHTML = '';
      }
      
      features.forEach((feature) => {
        feature.style.left = '';
        feature.style.top = '';
        feature.style.transform = '';
        feature.classList.add('positioned');
      });
    }
    
    // Setup interactions after positioning
    setupInteractions();
  }
  
  // Initial positioning
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', positionFeatures);
  } else {
    setTimeout(positionFeatures, 100);
  }
  
  // Reposition on window resize
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(positionFeatures, 250);
  });
  
  // Reposition when images load
  const images = document.querySelectorAll('#arc-content-' + sectionId + ' img');
  images.forEach(img => {
    if (img.complete) {
      positionFeatures();
    } else {
      img.addEventListener('load', positionFeatures);
    }
  });
})();
</script>

{% schema %}
{
  "name": "Circular Arc Features",
  "blocks": [
    {
      "type": "_arc-feature"
    }
  ],
  "disabled_on": {
    "groups": ["header"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Section settings"
    },
    {
      "type": "image_picker",
      "id": "center_image",
      "label": "Center Image"
    },
    {
      "type": "header",
      "content": "Layout settings"
    },
    {
      "type": "range",
      "id": "center_content_max_width",
      "label": "Center content max width",
      "min": 30,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 40
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "arc_radius_percent",
      "min": 20,
      "max": 48,
      "step": 1,
      "unit": "%",
      "label": "Arc Radius",
      "default": 37
    },
    {
      "type": "range",
      "id": "start_angle",
      "min": 0,
      "max": 360,
      "step": 10,
      "unit": "deg",
      "label": "Start Angle",
      "default": 220
    },
    {
      "type": "range",
      "id": "end_angle",
      "min": 0,
      "max": 720,
      "step": 10,
      "unit": "deg",
      "label": "End Angle",
      "default": 400
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "Mobile padding"
    },
    {
      "type": "checkbox",
      "id": "use_mobile_padding",
      "label": "Use mobile padding",
      "default": false
    },
    {
      "type": "range",
      "id": "padding-block-start-mobile",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0,
      "visible_if": "{{ section.settings.use_mobile_padding }}"
    },
    {
      "type": "range",
      "id": "padding-block-end-mobile",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0,
      "visible_if": "{{ section.settings.use_mobile_padding }}"
    }
  ],
  "presets": [
    {
      "name": "Circular Arc Features",
      "category": "t:categories.layout",
      "blocks": {
        "arc-features-heading": {
          "type": "text",
          "name": "Heading",
          "static": true,
          "settings": {
            "text": "<h2>Arc Features</h2>",
            "width": "100%",
            "alignment": "center",
            "padding-block-end": 10
          }
        },
        "arc-features-description": {
          "type": "text",
          "name": "Description",
          "static": true,
          "settings": {
            "text": "<p>A dynamic section that displays feature items positioned along a circular arc path.</p>",
            "width": "100%",
            "alignment": "center"
          }
        },
        "feature-1": {
          "type": "_arc-feature",
          "settings": {
            "title": "Fast & Free Shipping",
            "description": "<p>Get your order delivered quickly with no extra cost.</p>",
          },
          "blocks": {
            "feature-group": {
              "type": "group",
              "static": true,
              "name": "Center Content Group",
              "settings": {
                "inherit_color_scheme": false,
                "color_scheme": "scheme-2",
                "padding-block-start": 20,
                "padding-block-end": 20,
                "padding-inline-start": 20,
                "padding-inline-end": 20,
                "use_mobile_padding": true,
                "padding-block-start-mobile": 10,
                "padding-block-end-mobile": 10,
                "padding-inline-start-mobile": 10,
                "padding-inline-end-mobile": 10
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "name": "t:names.heading",
                  "settings": {
                    "text": "<h2>Fast & Free Shipping</h2>"
                  }
                },
                "text": {
                  "type": "text",
                  "name": "t:names.text",
                  "settings": {
                    "text": "<p>We offer fast, reliable, and free shipping on all orders above a certain amount. Your products are carefully packed and shipped within 24–48 hours.</p>",
                    "width": "100%"
                  }
                }
              },
              "block_order": ["heading","text"]
            }
          },
          "block_order": ["group"]
        },
        "feature-2": {
          "type": "_arc-feature",
          "settings": {
            "title": "Easy Returns",
            "description": "<p>Hassle-free returns within 30 days.</p>",
          },
          "blocks": {
            "feature-group": {
              "type": "group",
              "static": true,
              "name": "Center Content Group",
              "settings": {
                "inherit_color_scheme": false,
                "color_scheme": "scheme-2",
                "padding-block-start": 20,
                "padding-block-end": 20,
                "padding-inline-start": 20,
                "padding-inline-end": 20,
                "use_mobile_padding": true,
                "padding-block-start-mobile": 10,
                "padding-block-end-mobile": 10,
                "padding-inline-start-mobile": 10,
                "padding-inline-end-mobile": 10
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "name": "t:names.heading",
                  "settings": {
                    "text": "<h2>Easy Returns</h2>"
                  }
                },
                "text": {
                  "type": "text",
                  "name": "t:names.text",
                  "settings": {
                    "text": "<p>Changed your mind? No problem. Enjoy a smooth return process within 30 days of receiving your order. Simply contact us and we’ll guide you through every step.</p>",
                    "width": "100%"
                  }
                }
              },
              "block_order": ["heading","text"]
            }
          },
          "block_order": ["group"]
        },
        "feature-3": {
          "type": "_arc-feature",
          "settings": {
            "title": "Secure Payments",
            "description": "<p>Your data and transactions are always protected.</p>",
          },
          "blocks": {
            "feature-group": {
              "type": "group",
              "static": true,
              "name": "Center Content Group",
              "settings": {
                "inherit_color_scheme": false,
                "color_scheme": "scheme-2",
                "padding-block-start": 20,
                "padding-block-end": 20,
                "padding-inline-start": 20,
                "padding-inline-end": 20,
                "use_mobile_padding": true,
                "padding-block-start-mobile": 10,
                "padding-block-end-mobile": 10,
                "padding-inline-start-mobile": 10,
                "padding-inline-end-mobile": 10
              },
              "blocks": {
                "heading": {
                  "type": "text",
                  "name": "t:names.heading",
                  "settings": {
                    "text": "<h2>Secure Payments</h2>"
                  }
                },
                "text": {
                  "type": "text",
                  "name": "t:names.text",
                  "settings": {
                    "text": "<p>We use industry-leading encryption and trusted payment gateways to ensure your checkout experience is safe and secure.</p>",
                    "width": "100%"
                  }
                }
              },
              "block_order": ["heading","text"]
            }
          },
          "block_order": ["group"]
        }
      },
      "block_order": [
        "feature-1",
        "feature-2",
        "feature-3"
      ]
    }
  ]
}
{% endschema %}